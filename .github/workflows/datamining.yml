name: Data Mining
on:
  workflow_dispatch:
    inputs:
      version:
        description: '游戏版本号(x.xx)'     
        required: true
        default: '5.41'

env:
  tag: patch-${{ github.event.inputs.version }}
  library_repo: thewakingsands/ffxiv-datamining-cn
  teamcraft_repo: ffxiv-teamcraft/ffxiv-teamcraft
  teamcraft_fork: zhyupe/ffxiv-teamcraft

jobs:
  server:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout 🛎️
      uses: actions/checkout@v2.3.1
      with:
        persist-credentials: false
        
    - name: Cache Node Dependencies 🎶
      id: cache
      uses: actions/cache@v1
      with:
        path: node_modules
        key: ${{runner.OS}}-npm-caches-${{ hashFiles('yarn.lock') }}

    - name: Fetch library
      run: git clone --branch $tag --depth 1 https://github.com/${library_repo}.git library
      
    - name: Check node version
      run: node -v
      
    - name: Install dependency
      run: yarn
      
    - name: Run script
      run: node server.js

    - name: Deploy to Github Pages 🚀
      uses: JamesIves/github-pages-deploy-action@4.1.0
      with:
        branch: gh-pages
        folder: dist
        clean: true

  teamcraft:
    runs-on: ubuntu-latest
    steps:
    - name: Fetch library
      run: git clone --branch $tag --depth 1 https://github.com/${library_repo}.git library
      
    - name: Clone teamcraft
      run: git clone --branch staging https://github.com/${teamcraft_repo}.git teamcraft
      
    - name: Check node version
      run: node -v

    - name: Replace source directory
      run: |
        sed -i "s/\/library\/[0-9.]\+\//\/library\//" teamcraft/data-extraction/data-exporter/config/zh.js
        sed -i "s/file: 'chs'/file: ''/" teamcraft/data-extraction/data-exporter/config/zh.js
      
    - name: Run data generator
      run: node teamcraft/data-extraction/data-exporter/index-zh.js
      
    - name: Setting origin
      run: |
        cd teamcraft
        git remote set-url origin https://github.com/${teamcraft_repo}
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.WORKER_ACCESS_KEY }}
        path: teamcraft
        commit-message: "feat(data): update for cn ${{ env.tag }}"
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        push-to-fork: ${{ env.teamcraft_fork }}
        branch: ci/zh/datamining-${{ env.tag }}
        base: staging
        title: "feat(data): update for cn ${{ env.tag }}"
        body: |
          This PR is automatically generated by [ffxiv-datamining-worker](https://github.com/zhyupe/ffxiv-datamining-worker)
